<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>门店销售逻辑测试 | Store Sales Logic Quiz</title>
<style>
  :root{
    --bg:#fffdf7; --bg2:#fff7e8; --text:#222; --muted:#5e6266;
    --brand:#7c4f1d; --gold:#d6b55b; --gold-soft:#fff1c6; --line:#eadfbc;
    --ok:#18a957; --bad:#e64646; --radius:16px; --shadow:0 10px 22px rgba(140,110,40,.15);
    --fz-title:18px; --fz-option:16px; --fz-body:15px; --fz-small:13px;
  }
  @media (min-width:480px){
    :root{ --fz-title:20px; --fz-option:17px; --fz-body:16px; --fz-small:14px; }
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","Noto Sans Thai",sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 100% -100px, #ffe7b3 0%, transparent 60%),
      radial-gradient(1000px 500px at -200px 100%, #fff3cc 0%, transparent 55%),
      var(--bg);
  }
  .wrap{max-width:820px;margin:0 auto;padding:18px env(safe-area-inset-right) calc(18px + env(safe-area-inset-bottom)) env(safe-area-inset-left)}
  .card{
    background:linear-gradient(180deg,#fffef9 0%, var(--bg2) 100%);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px;
  }
  header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  header h1{font-size:20px;margin:0;color:var(--brand)}
  p{margin:8px 0;font-size:var(--fz-body);color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type="text"]{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text);font-size:16px}
  .seg{display:flex;background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px;gap:4px}
  .seg button{flex:1;border:0;border-radius:999px;padding:10px 12px;background:transparent;color:var(--brand);font-weight:700}
  .seg button.active{background:var(--gold-soft);color:#7a501f}
  .btn{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(#e7c879,#d4b159);color:#3a2a12;font-weight:800;font-size:16px}
  .btn:active{transform:translateY(1px)}
  .btn.alt{background:linear-gradient(#ffffff,#fff5db)}
  .btn.link{background:#fff;border-style:dashed}
  .btn.pass{background:linear-gradient(#2ad07a,#18a957);color:#fff;border-color:#18a957}
  .btn.danger{background:linear-gradient(#ffb1a8,#ff8b7d);color:#5a0e0e;border-color:#ff8b7d}
  .kpi{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff; color:#6b4a1b;font-weight:700;font-size:var(--fz-small)}
  .progress{height:10px;background:#fff;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:linear-gradient(90deg,#ffd98a,#d6b55b);width:0%}
  .q-title{font-size:var(--fz-title);margin:6px 0 4px;color:#2a1b06}
  .q-sub{font-size:var(--fz-title);margin:0 0 12px;color:#2a1b06}
  .grid{display:grid;gap:10px}

  /* 选项 UI 升级 */
  .opt{display:flex;align-items:flex-start;gap:12px;padding:14px;border:1px solid var(--line);border-radius:14px;background:#fff;transition:.15s}
  .opt:hover{box-shadow:0 4px 12px rgba(140,110,40,.08)}
  .opt.selected{border-color:#d6b55b;background:#fffaf0;box-shadow:inset 0 0 0 2px #f1d58a}
  .opt input{width:22px;height:22px;margin-top:2px}
  .badge{width:28px;height:28px;border-radius:999px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-weight:800;color:#6b4a1b;background:#fff8e4;flex:0 0 28px}
  .opt-label{flex:1;font-size:var(--fz-option);line-height:1.35}

  .nav{display:flex;gap:10px;margin-top:12px}
  .ttsbar{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
  .ttsbar .btn{flex:1}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
  th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top;font-size:var(--fz-body)}
  th{background:#fff8e4;color:#6b4a1b;text-align:left}
  tr:last-child td{border-bottom:0}
  .ok{color:var(--ok);font-weight:700}
  .bad{color:var(--bad);font-weight:700}
  .tag{display:inline-block;border:1px solid #c3e9d5;background:#eefcf5;color:#0d7b45;padding:2px 8px;border-radius:999px;font-size:var(--fz-small)}
  .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#fffdf2 0%, rgba(255,251,235,.85) 100%);padding:8px 0 12px;margin:-8px 0 12px;backdrop-filter: blur(6px)}
  .hint{font-size:var(--fz-small);color:#7a7a7a}
  .warn{font-size:var(--fz-small);color:#b54700}
</style>
</head>
<body>
  <div class="wrap">

    <!-- Screen 1: 填姓名 + 难度 -->
    <div id="screen-start" class="card">
      <header>
        <h1>门店销售逻辑测试<br><span style="font-size:14px;color:#8a5b27">Store Sales Logic Quiz · แบบทดสอบตรรกะการขาย</span></h1>
      </header>
      <p>请填写姓名并选择难度。<br>Enter your name and choose a level.<br>โปรดกรอกชื่อและเลือกระดับข้อสอบ</p>
      <div class="row">
        <input id="nameInput" type="text" placeholder="姓名 / Name / ชื่อ" autocomplete="name" />
      </div>
      <div style="height:10px"></div>
      <h2 style="margin:0 0 6px;color:#7a501f;font-size:17px">难度 / Level / ระดับ</h2>
      <div class="seg" role="tablist" aria-label="Level">
        <button type="button" class="active" data-level="entry">入门 5题（20分钟） / Entry 5 (20m) / เริ่มต้น 5 (20นาที)</button>
        <button type="button" data-level="normal">常规 10题（40分钟） / Normal 10 (40m) / ปกติ 10 (40นาที)</button>
        <button type="button" data-level="hard">高阶 20题（60分钟） / Hard 20 (60m) / ขั้นสูง 20 (60นาที)</button>
      </div>
      <div style="height:12px"></div>
      <button id="startBtn" class="btn">开始考试 / Start Quiz / เริ่มทำแบบทดสอบ</button>
      <p class="hint">通过标准：≥80% 正确；Pass: ≥80% correct; ผ่านเกณฑ์: ถูก ≥80%</p>
    </div>

    <!-- Screen 2: 答题 -->
    <div id="screen-quiz" class="card" style="display:none">
      <div class="topbar">
        <div class="kpi">
          <div class="pill" id="pillName">姓名 / Name / ชื่อ：</div>
          <div class="pill" id="pillLevel">难度 / Level / ระดับ：</div>
          <div class="pill" id="pillCount">题目 / Q / ข้อ：0/0</div>
          <div class="pill" id="pillTime">剩余时间 / Time Left / เวลาคงเหลือ：--:--</div>
        </div>
        <div style="height:8px"></div>
        <div class="progress"><div id="progressBar"></div></div>
      </div>

      <div id="qBox">
        <div class="q-title" id="qTitleZH"></div>
        <div class="q-sub" id="qTitleEN"></div>
        <div class="q-sub" id="qTitleTH"></div>
        <div id="optBox" class="grid"></div>

        <div class="ttsbar">
          <button class="btn alt" id="btnReadZH">朗读中文</button>
          <button class="btn alt" id="btnReadEN">Read English</button>
          <button class="btn alt" id="btnReadTH">อ่านภาษาไทย</button>
          <button class="btn link" id="btnStop">停止朗读 / Stop / หยุดอ่าน</button>
        </div>
        <p class="warn" id="voiceWarn" style="display:none;"></p>
      </div>

      <div class="nav">
        <button class="btn alt" id="prevBtn">上一题 / Prev / ข้อก่อนหน้า</button>
        <button class="btn" id="nextBtn" disabled>下一题 / Next / ข้อต่อไป</button>
      </div>
    </div>

    <!-- Screen 3: 成绩 -->
    <div id="screen-result" class="card" style="display:none">
      <header style="margin-bottom:4px">
        <h1>成绩 / Result / ผลคะแนน</h1>
      </header>
      <div class="row">
        <div class="pill" id="rName"></div>
        <div class="pill" id="rLevel"></div>
        <div class="pill" id="rScore"></div>
        <div class="pill" id="rPass"></div>
      </div>
      <p id="passNote" style="margin-top:8px;"></p>

      <h2 style="color:#7a501f;font-size:18px">答题明细 / Answer Review / รายละเอียดคำตอบ</h2>
      <table id="resultTable">
        <thead>
          <tr>
            <th>#</th>
            <th>题目 / Question / คำถาม</th>
            <th>你的答案 / Your Answer / คำตอบของคุณ</th>
            <th>正确答案 / Correct / คำตอบที่ถูก</th>
            <th>解析 / Explanation / คำอธิบาย</th>
            <th>结果 / Result / ผลลัพธ์</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="nav">
        <button class="btn link" id="copyKey">复制学习版答案 / Copy Study Key / คัดลอกเฉลย</button>
        <button class="btn link" id="againSame">再测一次（同难度） / Retake Same Level / ทำใหม่ระดับเดิม</button>
        <button class="btn pass" id="againStart">返回开始 / Back to Start / กลับหน้าแรก</button>
      </div>
    </div>
  </div>

<script>
/* ===================== 配置区（倒计时时长，单位：秒） ===================== */
const DURATIONS = { entry:20*60, normal:40*60, hard:60*60 };

/* ===================== 小工具（修复 checked 造成的误选） ===================== */
const $ = s=>document.querySelector(s);
function el(tag, attrs={}, children=[]){
  const node = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)){
    if(v===null || v===undefined || v===false) continue; // 关键：忽略空值，避免生成 checked="null"
    if(k==='class') node.className=v;
    else if(k==='html') node.innerHTML=v;
    else if(k==='text') node.textContent=v;
    else if(k==='checked'){ node.checked = !!v; } // 用属性而非 setAttribute
    else node.setAttribute(k,v);
  }
  children.forEach(c=> node.appendChild(c));
  return node;
}
const shuffle = (arr)=>{ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
const pad = n => String(n).padStart(2,'0');

/* ===================== 题库（20题；中/英/泰） ===================== */
const BANK_ALL = [
  { zh:"为什么不能在客户刚进店时就直接进入成交环节？",
    en:"Why should salespeople avoid jumping directly to the closing stage when customers enter the store?",
    th:"ทำไมพนักงานขายจึงไม่ควรเข้าสู่ขั้นปิดการขายทันทีเมื่อลูกค้าเข้าร้าน?",
    options:[
      {zh:"因为这样显得不礼貌", en:"Because it seems impolite", th:"เพราะดูไม่สุภาพ"},
      {zh:"因为大多数客户进店没有明确目的，需要先建立链接", en:"Because most customers enter without a clear purpose and need connection first", th:"เพราะลูกค้าส่วนใหญ่ยังไม่มีเป้าหมายชัด ต้องสร้างความเชื่อมโยงก่อน", correct:true},
      {zh:"因为这样会浪费时间", en:"Because it wastes time", th:"เพราะเปลืองเวลา"},
      {zh:"因为客户喜欢先看折扣", en:"Because customers prefer discounts first", th:"เพราะลูกค้าชอบดูส่วนลดก่อน"}
    ],
    exp_zh:"多数来访者处于探索状态，需先建立链接和信任，再进入需求挖掘与推进。",
    exp_en:"Most entrants are browsing; build rapport and context before need discovery and closing.",
    exp_th:"ผู้เข้าร้านส่วนใหญ่ยังสำรวจอยู่ ต้องสร้างความคุ้นเคยและความไว้วางใจก่อนจึงค่อยค้นหาความต้องการและปิดการขาย"
  },
  { zh:"销售流程中的第一步逻辑应该是什么？",
    en:"What should be the first logical step in the sales process?",
    th:"ขั้นตอนแรกที่ถูกต้องในกระบวนการขายคืออะไร?",
    options:[
      {zh:"直接介绍爆品", en:"Directly introduce bestsellers", th:"แนะนำสินค้าขายดีทันที"},
      {zh:"建立联系并进入破冰环节", en:"Build connection and start with ice-breaking", th:"สร้างความเชื่อมโยงและเริ่มละลายพฤติกรรม", correct:true},
      {zh:"给客户讲解价格体系", en:"Explain pricing system", th:"อธิบายโครงสร้างราคา"},
      {zh:"带客户随便逛店", en:"Let the customer wander around", th:"ปล่อยให้ลูกค้าเดินดูเอง"}
    ],
    exp_zh:"破冰是承上启下的衔接点，降低戒备、建立信任。",
    exp_en:"Ice-breaking connects stages, reduces friction, and builds trust.",
    exp_th:"การละลายพฤติกรรมช่วยเชื่อมขั้นตอน ลดความเกร็ง และสร้างความไว้วางใจ"
  },
  { zh:"品牌宣导在销售逻辑中起到什么作用？",
    en:"What role does brand storytelling play in the sales logic?",
    th:"การเล่าเรื่องแบรนด์มีบทบาทอย่างไรในตรรกะการขาย?",
    options:[
      {zh:"用于打发时间", en:"To kill time", th:"เพื่อฆ่าเวลา"},
      {zh:"增强差异化，避免客户只关注比价", en:"Strengthen differentiation and prevent price-only comparison", th:"เสริมความแตกต่าง ป้องกันการเทียบราคาอย่างเดียว", correct:true},
      {zh:"让客户立即付款", en:"To make customers pay immediately", th:"ทำให้ลูกค้าจ่ายทันที"},
      {zh:"替代产品介绍", en:"To replace product introduction", th:"ใช้แทนการแนะนำสินค้า"}
    ],
    exp_zh:"差异化叙事让客户采用非价格标准评估你，从而避免比价陷阱。",
    exp_en:"Differentiation reframes evaluation criteria beyond price and avoids price wars.",
    exp_th:"การเล่าเรื่องที่แตกต่างทำให้ลูกค้าประเมินด้วยเกณฑ์อื่นนอกจากราคา ลดการแข่งราคาตรงๆ"
  },
  { zh:"如果客户说“只是随便看看”，销售应如何逻辑推进？",
    en:"If a customer says “I am just browsing,” how should the salesperson logically proceed?",
    th:"หากลูกค้าบอกว่า “แวะมาดูเฉยๆ” ควรเดินเรื่องอย่างไร?",
    options:[
      {zh:"停止接待", en:"Stop serving", th:"หยุดบริการ"},
      {zh:"强行推销黄金", en:"Push gold products directly", th:"ยัดเยียดขายทองทันที"},
      {zh:"引导客户到新品或特色区域", en:"Guide the customer to new arrivals or special sections", th:"พาไปโซนสินค้าใหม่หรือจุดเด่นของร้าน", correct:true},
      {zh:"马上给折扣", en:"Offer discounts immediately", th:"ให้ส่วนลดทันที"}
    ],
    exp_zh:"用场景与专区引导兴趣与注意力，再逐步挖掘需求。",
    exp_en:"Use curated areas to focus attention first, then discover needs.",
    exp_th:"ใช้โซน/ธีมช่วยโฟกัสความสนใจ แล้วค่อยสำรวจความต้องการทีละขั้น"
  },
  { zh:"为什么门店需要设立“爆品区”？",
    en:"Why should the store set up a “bestseller zone”?",
    th:"ทำไมร้านควรมี “โซนสินค้าขายดี” ?",
    options:[
      {zh:"为了清理库存", en:"To clear old stock", th:"เพื่อระบายสต็อกเก่า"},
      {zh:"让客户快速聚焦畅销款，提高转化效率", en:"To quickly focus customers on popular items and improve conversion", th:"ทำให้ลูกค้าโฟกัสสินค้ายอดนิยมและเพิ่มอัตราปิดการขาย", correct:true},
      {zh:"因为店面需要装饰", en:"Because the store needs decoration", th:"เพราะต้องตกแต่งร้าน"},
      {zh:"为了减少销售员介绍产品的工作量", en:"To reduce salesperson’s workload", th:"เพื่อลดงานแนะนำสินค้า"}
    ],
    exp_zh:"缩短选择路径，降低决策成本，形成“先易后难”的推进。",
    exp_en:"Shortens decision path and reduces cognitive load, improving conversion.",
    exp_th:"ย่นเส้นทางการเลือก ลดภาระการตัดสินใจ เพิ่มโอกาสปิดการขาย"
  },
  { zh:"在销售逻辑中，“种草”的核心意义是什么？",
    en:"What is the core meaning of “seeding” in sales logic?",
    th:"สาระสำคัญของการ “ปักหมุด/ปูพรมความสนใจ (seeding)” คืออะไร?",
    options:[
      {zh:"强调客户必须买", en:"Forcing the customer to buy", th:"กดดันให้ต้องซื้อ"},
      {zh:"潜移默化地制造兴趣，引导客户形成需求", en:"Subtly creating interest and guiding customers to form demand", th:"ค่อยๆ ปลูกความสนใจและชี้นำให้เกิดความต้องการ", correct:true},
      {zh:"用来代替品牌宣导", en:"To replace brand storytelling", th:"ใช้แทนการเล่าเรื่องแบรนด์"},
      {zh:"只在清仓活动时使用", en:"Only used during clearance sales", th:"ใช้เฉพาะช่วงล้างสต็อก"}
    ],
    exp_zh:"通过重复与场景展示持续提醒，促成“自我发现”的偏好形成。",
    exp_en:"Repeated cues and contexts help customers ‘self-discover’ preferences.",
    exp_th:"การย้ำเตือนและจัดบริบทช่วยให้ลูกค้า ‘ค้นพบ’ ความชอบด้วยตัวเอง"
  },
  { zh:"为什么要逐步引导客户，而不是被动跟随客户？",
    en:"Why should salespeople guide customers step by step instead of passively following them?",
    th:"ทำไมต้องค่อยๆ นำทางลูกค้า แทนการเดินตามแบบตั้งรับ?",
    options:[
      {zh:"因为这样更快成交", en:"Because it closes deals faster", th:"เพราะปิดการขายได้เร็วกว่า"},
      {zh:"因为可以控制客户体验和节奏", en:"Because it allows control of customer experience and pace", th:"เพราะควบคุมประสบการณ์และจังหวะได้", correct:true},
      {zh:"因为客户喜欢被控制", en:"Because customers like being controlled", th:"เพราะลูกค้าชอบถูกควบคุม"},
      {zh:"因为这样能减少介绍产品数量", en:"Because it reduces product introduction workload", th:"เพราะลดงานแนะนำสินค้า"}
    ],
    exp_zh:"主动设计路径与节奏，提升体验的连贯性与专业感。",
    exp_en:"Proactive pacing creates a coherent, professional experience.",
    exp_th:"การออกแบบเส้นทางและจังหวะเชิงรุก ทำให้ประสบการณ์ลื่นไหลและเป็นมืออาชีพ"
  },
  { zh:"统一的话术“你好，欢迎，想看点啥”为什么会带来风险？",
    en:"Why is it risky if all salespeople use the same greeting “Hello, welcome, what do you want to see?”",
    th:"ทักทายแบบเดียวกันว่า “สวัสดี สนใจดูอะไรครับ/คะ” มีความเสี่ยงอย่างไร?",
    options:[
      {zh:"容易让客户产生审美疲劳", en:"It makes customers feel bored", th:"ทำให้ลูกค้าเบื่อ"},
      {zh:"容易让客户进入比价模式，无法突出差异化", en:"It pushes customers into price comparison, losing differentiation", th:"พาลูกค้าเข้าสู่โหมดเทียบราคา ทำให้แตกต่างไม่ได้", correct:true},
      {zh:"因为客户喜欢更长的问候", en:"Because customers prefer longer greetings", th:"เพราะลูกค้าชอบทักยาวๆ"},
      {zh:"因为客户会怀疑产品质量", en:"Because customers may doubt product quality", th:"เพราะลูกค้าจะสงสัยคุณภาพสินค้า"}
    ],
    exp_zh:"缺少差异化，客户默认你与他店同质，从而进入比价框架。",
    exp_en:"Lack of differentiation frames you as generic, triggering price-only comparison.",
    exp_th:"ไม่มีความแตกต่าง ลูกค้าจะมองว่าเหมือนร้านทั่วไป จึงเทียบราคาเป็นหลัก"
  },
  { zh:"在销售逻辑中，什么时候提出产品选择问题最合适？",
    en:"When is the best timing to ask the customer about specific product choices?",
    th:"จังหวะไหนเหมาะที่สุดในการถามความต้องการเลือกสินค้าเฉพาะ?",
    options:[
      {zh:"一进店就立刻询问", en:"Immediately when they enter", th:"ทันทีที่เข้าร้าน"},
      {zh:"在品牌宣导之后，引导到爆品区时", en:"After brand introduction, when guiding to the bestseller zone", th:"หลังเล่าแบรนด์และพาไปโซนขายดี", correct:true},
      {zh:"在客户准备离店时", en:"When the customer is about to leave", th:"ตอนลูกค้ากำลังจะออก"},
      {zh:"在客户看完所有柜台之后", en:"After the customer has browsed all counters", th:"หลังเดินดูครบทุกตู้แล้ว"}
    ],
    exp_zh:"先建立框架与信任，再在聚焦场域内缩小选择。",
    exp_en:"Build frame and trust first; narrow choices within a focused area.",
    exp_th:"สร้างกรอบและความเชื่อใจก่อน แล้วค่อยจำกัดทางเลือกในพื้นที่โฟกัส"
  },
  { zh:"为什么销售流程必须包含“逻辑衔接”环节？",
    en:"Why must the sales process include logical transition steps?",
    th:"ทำไมกระบวนการขายต้องมีช่วง ‘เชื่อมตรรกะ/เปลี่ยนผ่าน’?",
    options:[
      {zh:"因为这样可以增加对话长度", en:"Because it makes conversations longer", th:"เพราะทำให้คุยได้นานขึ้น"},
      {zh:"因为客户需要被一步步引导才能形成购买意愿", en:"Because customers need step-by-step guidance to develop buying intent", th:"เพราะลูกค้าต้องการการนำทางทีละขั้นเพื่อก่อรูปความตั้งใจซื้อ", correct:true},
      {zh:"因为门店规定", en:"Because it is a store rule", th:"เพราะเป็นกฎของร้าน"},
      {zh:"因为销售员记不住太多台词", en:"Because salespeople cannot memorize too many lines", th:"เพราะพนักงานจำสคริปต์เยอะไม่ได้"}
    ],
    exp_zh:"衔接让信息与体验连贯，逐层推进意愿形成与承诺。",
    exp_en:"Transitions ensure coherence, progressively building intent and commitment.",
    exp_th:"ช่วงเปลี่ยนผ่านทำให้ข้อมูลและประสบการณ์ต่อเนื่อง สร้างความตั้งใจและคำมั่นในการซื้อทีละชั้น"
  },
  { zh:"在客户进店后，为什么破冰环节至关重要？",
    en:"Why is the ice-breaking stage critical after a customer enters the store?",
    th:"ทำไมช่วงละลายพฤติกรรมจึงสำคัญหลังลูกค้าเข้าร้าน?",
    options:[
      {zh:"因为可以立即推销产品", en:"Because it allows immediate product selling", th:"เพราะขายสินค้าได้ทันที"},
      {zh:"因为它能打破沉默并建立信任感", en:"Because it breaks the silence and builds trust", th:"เพราะช่วยทำลายความเงียบและสร้างความไว้วางใจ", correct:true},
      {zh:"因为客户会主动提需求", en:"Because customers will state their needs directly", th:"เพราะลูกค้าจะบอกความต้องการเอง"},
      {zh:"因为能减少介绍产品时间", en:"Because it reduces product introduction time", th:"เพราะช่วยลดเวลานำเสนอสินค้า"}
    ],
    exp_zh:"降低社交阻抗，建立情绪安全，才便于信息交换。",
    exp_en:"Reduces social friction and builds safety for meaningful exchange.",
    exp_th:"ลดแรงต้านทางสังคม สร้างความสบายใจ เพื่อเปิดการสื่อสารที่มีคุณภาพ"
  },
  { zh:"品牌宣导中提到“历史和传承”的作用是什么？",
    en:"What is the role of highlighting “history and heritage” in brand storytelling?",
    th:"บทบาทของการเน้น ‘ประวัติและมรดกแบรนด์’ คืออะไร?",
    options:[
      {zh:"证明价格合理", en:"To justify the pricing", th:"เพื่ออธิบายราคาว่าสมเหตุผล"},
      {zh:"建立专业感和可靠度", en:"To establish professionalism and reliability", th:"เพื่อสร้างภาพลักษณ์ความเชี่ยวชาญและความน่าเชื่อถือ", correct:true},
      {zh:"填补对话空白", en:"To fill silence in conversation", th:"เพื่อถมความเงียบในการสนทนา"},
      {zh:"替代售后服务", en:"To replace after-sales service", th:"ใช้แทนบริการหลังการขาย"}
    ],
    exp_zh:"稳定预期与信任基线，强化可靠性与选择理由。",
    exp_en:"Sets trust baselines and strengthens reasons to choose you.",
    exp_th:"วางฐานความเชื่อใจและเหตุผลในการเลือกแบรนด์ของคุณ"
  }
];

/* 分层：入门5、常规10、硬核20 */
const BANK_ENTRY  = BANK_ALL.slice(0,5);
const BANK_NORMAL = BANK_ALL.slice(0,10);
const BANK_HARD   = BANK_ALL.slice(0,20);

/* ===================== 状态 & 朗读（可选语言） ===================== */
let state = { name:"", level:"entry", chosen:[], answers:{}, pos:0 };
const LEVEL_TEXT = {entry:"入门/Entry/เริ่มต้น", normal:"常规/Normal/ปกติ", hard:"高阶/Hard/ขั้นสูง"};

let zhVoice=null, enVoice=null, thVoice=null, ttsPlaying=false;
function pickVoices(){
  const v = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  zhVoice = v.find(x=>/zh|cmn|Chinese/i.test(x.lang)) || v.find(x=>/HK|TW/i.test(x.lang)) || null;
  enVoice = v.find(x=>/^en[-_]/i.test(x.lang)) || null;
  thVoice = v.find(x=>/^th[-_]/i.test(x.lang)) || null;
  updateVoiceWarn();
}
function updateVoiceWarn(){
  const warn = [];
  if(!zhVoice) warn.push("未检测到中文语音（某些设备需在系统里安装语音包）");
  if(!enVoice) warn.push("No English voice detected on this device.");
  if(!thVoice) warn.push("ไม่พบเสียงภาษาไทยในอุปกรณ์นี้ (อาจต้องติดตั้งแพ็กเสียง)");
  const box = $('#voiceWarn');
  if(warn.length){ box.style.display='block'; box.innerHTML = warn.join("<br>"); }
  else { box.style.display='none'; box.textContent=''; }
}
if ('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = pickVoices; pickVoices(); }

function speakOnce(text, voice, rate=1, pitch=1){
  return new Promise(res=>{
    if(!('speechSynthesis' in window)||!text){res();return;}
    const u = new SpeechSynthesisUtterance(text);
    if(voice) u.voice = voice;
    u.rate = rate; u.pitch = pitch;
    u.onend = res; u.onerror = res;
    speechSynthesis.speak(u);
  });
}
async function readQuestionBy(lang){
  if(ttsPlaying) return;
  const q = state.chosen[state.pos];
  const voice = (lang==='zh')? zhVoice : (lang==='en'? enVoice : thVoice);
  if(!voice){ updateVoiceWarn(); return; }
  ttsPlaying = true;
  try{
    await speakOnce(q[lang], voice, 1.02, 1.0); if(!ttsPlaying) return;
    for(let i=0;i<q.options.length;i++){
      const A = String.fromCharCode(65+i) + (lang==='en'?'. ': ' ');
      await speakOnce(A + q.options[i][lang], voice, 1.02, 1.0);
      if(!ttsPlaying) return;
    }
  } finally { ttsPlaying=false; }
}
function stopReading(){
  if('speechSynthesis' in window){ try{ speechSynthesis.cancel(); }catch(e){} }
  ttsPlaying=false;
}

/* ===================== 计时器（自动开始、到时交卷） ===================== */
let timerInterval = null;
let timerDeadline = 0;
function startTimerForLevel(level){
  const map={entry:20*60,normal:40*60,hard:60*60};
  const secs = map[level] || 20*60;
  timerDeadline = Date.now() + secs*1000;
  updateTimer();
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 1000);
}
function updateTimer(){
  const remainMs = Math.max(0, timerDeadline - Date.now());
  const totalSec = Math.round(remainMs/1000);
  const m = Math.floor(totalSec/60);
  const s = totalSec%60;
  $('#pillTime').textContent = `剩余时间 / Time Left / เวลาคงเหลือ：${pad(m)}:${pad(s)}`;
  if(totalSec <= 0){
    clearInterval(timerInterval); timerInterval = null;
    stopReading();
    alert('时间到 / Time is up / หมดเวลา');
    if($('#screen-quiz').style.display!=='none'){ finishQuiz(); }
  }
}
function stopTimer(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } }

/* ===================== 事件绑定 ===================== */
document.querySelectorAll('#screen-start .seg[aria-label="Level"] button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#screen-start .seg[aria-label="Level"] button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    state.level = btn.dataset.level;
  });
});
$('#startBtn').addEventListener('click', ()=>{
  const name = $('#nameInput').value.trim();
  if(!name){ $('#startBtn').classList.add('danger'); setTimeout(()=>$('#startBtn').classList.remove('danger'),600); $('#nameInput').focus(); return; }
  state.name = name; startQuiz();
});
$('#prevBtn').addEventListener('click', ()=>{ if(state.pos>0){ stopReading(); state.pos--; renderQuestion(); } });
$('#nextBtn').addEventListener('click', ()=>{
  if(state.pos < state.chosen.length-1){ stopReading(); state.pos++; renderQuestion(); }
  else { stopReading(); finishQuiz(); }
});
$('#againSame').addEventListener('click', ()=>{ stopReading(); startQuiz(); });
$('#againStart').addEventListener('click', ()=>{
  stopReading(); stopTimer();
  $('#screen-quiz').style.display='none';
  $('#screen-result').style.display='none';
  $('#screen-start').style.display='block';
  window.scrollTo({top:0, behavior:'smooth'});
});
$('#copyKey').addEventListener('click', ()=>{
  const text = buildStudyKey(state.chosen);
  navigator.clipboard?.writeText(text).then(()=>{ alert('已复制学习版答案 / Copied study key / คัดลอกเฉลยแล้ว'); })
  .catch(()=>{
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    alert('已复制学习版答案 / Copied study key / คัดลอกเฉลยแล้ว');
  });
});
$('#btnReadZH').addEventListener('click', ()=>readQuestionBy('zh'));
$('#btnReadEN').addEventListener('click', ()=>readQuestionBy('en'));
$('#btnReadTH').addEventListener('click', ()=>readQuestionBy('th'));
$('#btnStop').addEventListener('click', stopReading);

/* ===================== 出题/渲染/交卷 ===================== */
function getBank(){
  return state.level==='entry'?BANK_ENTRY:(state.level==='normal'?BANK_NORMAL:BANK_HARD);
}
function startQuiz(){
  const base = getBank();
  state.chosen = shuffle(base).map(q=>{
    const opts = shuffle(q.options.map(o=>({...o})));
    const correctIndex = opts.findIndex(o=>o.correct===true);
    return { zh:q.zh, en:q.en, th:q.th, options:opts, correctIndex, exp_zh:q.exp_zh, exp_en:q.exp_en, exp_th:q.exp_th };
  });
  state.answers = {};
  state.pos = 0;

  $('#screen-start').style.display='none';
  $('#screen-result').style.display='none';
  $('#screen-quiz').style.display='block';
  $('#pillName').textContent = `姓名/Name/ชื่อ：${state.name}`;
  $('#pillLevel').textContent = `难度/Level/ระดับ：${LEVEL_TEXT[state.level]}`;

  startTimerForLevel(state.level);
  renderQuestion();
}
function renderQuestion(){
  const q = state.chosen[state.pos];
  $('#qTitleZH').textContent = q.zh;
  $('#qTitleEN').textContent = q.en;
  $('#qTitleTH').textContent = q.th;

  const optBox = $('#optBox');
  optBox.innerHTML='';
  q.options.forEach((opt, idx)=>{
    const id = `q${state.pos}_opt${idx}`;
    const isChecked = state.answers[state.pos] === idx;
    const row = el('label', {class:`opt${isChecked?' selected':''}`, for:id}, [
      el('input', {type:'radio', name:'opt', id, 'data-idx':idx, checked:isChecked}),
      el('div', {class:'badge', text:String.fromCharCode(65+idx)}),
      el('div', {class:'opt-label', html:`${opt.zh}<br>${opt.en}<br>${opt.th}`})
    ]);
    optBox.appendChild(row);
  });
  optBox.querySelectorAll('input[type=radio]').forEach(r=>{
    r.addEventListener('change', ()=>{
      state.answers[state.pos] = parseInt(r.dataset.idx,10);
      // 高亮所选
      optBox.querySelectorAll('.opt').forEach(x=>x.classList.remove('selected'));
      r.closest('.opt')?.classList.add('selected');
      $('#nextBtn').disabled = false;
    });
  });

  // 恢复“已作答”状态时，允许直接 Next
  $('#nextBtn').disabled = (state.answers[state.pos] == null);
  $('#nextBtn').textContent = (state.pos === state.chosen.length-1) ? '提交 / Submit / ส่งคำตอบ' : '下一题 / Next / ข้อต่อไป';
  $('#prevBtn').disabled = (state.pos === 0);

  $('#pillCount').textContent = `题目/Q/ข้อ：${state.pos+1}/${state.chosen.length}`;
  const pct = Math.round((state.pos)/Math.max(1,(state.chosen.length-1))*100);
  $('#progressBar').style.width = `${pct}%`;
}
function finishQuiz(){
  stopTimer();
  let correct = 0;
  const rows = [];
  state.chosen.forEach((q, i)=>{
    const chosenIdx = state.answers[i];
    const ok = (chosenIdx === q.correctIndex);
    if(ok) correct++;
    const your = chosenIdx!=null ? fmtOpt(q.options[chosenIdx], chosenIdx) : '<span class="bad">未作答 / No answer / ไม่ได้ตอบ</span>';
    const corr = fmtOpt(q.options[q.correctIndex], q.correctIndex);
    const exp  = `${q.exp_zh}<br>${q.exp_en}<br>${q.exp_th}`;
    rows.push({ no:i+1, title:`${q.zh}<br>${q.en}<br>${q.th}`, your, corr, exp, ok });
  });
  const total = state.chosen.length;
  const scorePct = Math.round(correct/total*100);
  const passLine = Math.ceil(total*0.8);
  const pass = correct >= passLine;

  $('#screen-quiz').style.display='none';
  $('#screen-result').style.display='block';
  $('#rName').textContent = `姓名/Name/ชื่อ：${state.name}`;
  $('#rLevel').textContent = `难度/Level/ระดับ：${LEVEL_TEXT[state.level]}`;
  $('#rScore').textContent = `分数/Score/คะแนน：${correct}/${total}（${scorePct}%）`;
  $('#rPass').innerHTML = pass ? `<span class="tag">通过/PASS/ผ่าน</span>` : `<span class="tag" style="border-color:#ffd0d0;background:#fff0f0;color:#bb1e1e">未通过/FAIL/ไม่ผ่าน</span>`;
  $('#passNote').innerHTML = pass
    ? `🎉 恭喜通过！Congrats! ยินดีด้วย!`
    : `未通过，请复习解析后重测。Not passed—review and retry. โปรดทบทวนคำอธิบายแล้วทำใหม่`;

  const tb = $('#resultTable tbody');
  tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.no}</td>
      <td>${r.title}</td>
      <td>${r.your}</td>
      <td>${r.corr}</td>
      <td>${r.exp}</td>
      <td>${r.ok?'<span class="ok">正确/Correct/ถูก</span>':'<span class="bad">错误/Wrong/ผิด</span>'}</td>
    `;
    tb.appendChild(tr);
  });

  window.scrollTo({top:0, behavior:'smooth'});

  function fmtOpt(opt, idx){
    const letter = idx!=null ? `(${String.fromCharCode(65+idx)}) ` : '';
    return `${letter}${opt.zh}<br>${opt.en}<br>${opt.th}`;
  }
}

/* 学习版答案（更清晰的复制格式） */
function buildStudyKey(chosen){
  const now = new Date();
  let out = `===== 学习版答案 | Study Key | กุญแจเฉลย =====\n`;
  out += `姓名/Name/ชื่อ: ${state.name}\n难度/Level/ระดับ: ${LEVEL_TEXT[state.level]}\n日期/Date: ${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}\n`;
  out += `--------------------------------------------------\n`;
  chosen.forEach((q,i)=>{
    const corIdx = q.correctIndex;
    const cor = q.options[corIdx];
    const L = String.fromCharCode(65+corIdx);
    out += `Q${i+1}\n`;
    out += `CN: ${q.zh}\nEN: ${q.en}\nTH: ${q.th}\n`;
    out += `Correct ${L}: ${cor.zh} | ${cor.en} | ${cor.th}\n`;
    out += `Explain: ${q.exp_zh} | ${q.exp_en} | ${q.exp_th}\n`;
    out += `--------------------------------------------------\n`;
  });
  return out;
}
</script>
</body>
</html>
